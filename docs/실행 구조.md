# MOBY Edge 시스템 실행 구조

**최종 업데이트:** 2025-12-02

---

## 📊 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MOBY Edge 시스템 구성도                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐      ┌──────────────────┐      ┌──────────────────┐
│  motor_PdM.py    │      │ sensor_final.py  │      │inference_worker  │
│  (모터 + RUL)    │      │ (센서 수집)       │      │  (추론 엔진)      │
├──────────────────┤      ├──────────────────┤      ├──────────────────┤
│ • TB6612 모터    │      │ • DHT11 (1Hz)    │      │ • Isolation      │
│ • IR 센서        │      │ • 진동 (12.8Hz)  │      │   Forest         │
│ • RUL 예측       │      │ • 음향 (12.8Hz)  │      │ • MLP Classifier │
│   (3단계)        │      │ • MPU6050        │      │   (ONNX)         │
│                  │      │   (12.8Hz)       │      │ • V17 특징 추출  │
│                  │      │ • BMP180 (1Hz)   │      │   (15개)         │
└────────┬─────────┘      └────────┬─────────┘      └────────┬─────────┘
         │                         │                         │
         │ MQTT                    │ MQTT                    │ MQTT
         ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MQTT Broker (192.168.80.143)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  factory/conveyor/ir              - 모터 회전 주기 & RUL 예측               │
│  factory/sensor/*                 - 원본 센서 데이터                         │
│  factory/inference/windows/*      - 추론용 윈도우 메시지                     │
│  factory/inference/results/*      - 모델 추론 결과                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔧 컴포넌트 상세

### 1️⃣ motor_PdM.py (모터 제어 + RUL 예측)

| 항목 | 설명 |
|------|------|
| **GPIO 제어** | AIN1(27), AIN2(22), PWMA(18), STBY(23) |
| **모터 구동** | PWM 100Hz, 68% Duty |
| **IR 센서** | GPIO 17, 회전 감지 |
| **RUL 예측** | 사이클 시간 기반 고장 예측 |
| **MQTT 발행** | `factory/conveyor/ir` |

**v2 개선사항:**
- 3단계 건강 상태: 🟢 NORMAL → 🟡 WARNING → 🔴 CRITICAL
- IQR 기반 이상치 필터링
- 베이스라인: 4583ms, WARNING: +5%, CRITICAL: +10%

---

### 2️⃣ sensor_final.py (다중 센서 수집)

| 센서 | 주파수 | MQTT 토픽 |
|------|--------|-----------|
| DHT11 (습도) | 1 Hz | `factory/sensor/dht11` |
| SEN0209 (진동) | 12.8 Hz | `factory/sensor/vibration` |
| SZH-EK087 (음향) | 12.8 Hz | `factory/sensor/sound` |
| MPU6050 (IMU) | 12.8 Hz | `factory/sensor/accel_gyro` |
| BMP180 (기압) | 1 Hz | `factory/sensor/pressure` |

**윈도우 관리:**
- 윈도우 크기: 10초 (약 128 샘플)
- 윈도우 겹침: 5초
- 발행 토픽: `factory/inference/windows/accel_gyro`

**v2 개선사항:**
- 샘플링 레이트 12.8Hz로 통일 (학습 데이터와 일치)
- Pressure/Temperature 데이터 윈도우에 포함

---

### 3️⃣ inference_worker.py (추론 엔진)

| 항목 | 설명 |
|------|------|
| **구독 토픽** | `factory/inference/windows/#` |
| **특징 추출** | V17 (15개 특징) |
| **모델** | Isolation Forest, MLP Classifier (ONNX) |
| **발행 토픽** | `factory/inference/results/<sensor>/<model>` |

**특징 목록 (V17):**
```
Accel (9): VectorRMS, PC1_PeakToPeak, VectorCrestFactor, PC1_DominantFreq,
           PC1_RMSF, PC1_VarianceRatio, PC1_Direction_X/Y/Z
Gyro (4):  VectorRMS, STD_X, STD_Y, STD_Z
Env (2):   pressure_Mean, temperature_Mean
```

---

## 📈 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              데이터 흐름도                                   │
└─────────────────────────────────────────────────────────────────────────────┘

[모터 시스템]
┌──────────────┐
│ motor_PdM.py │
│              │ ──MQTT──→ factory/conveyor/ir
│  IR 센서     │           {"health": "NORMAL", "avg_cycle_ms": 4600,
│  회전 감지   │            "rul_hours": 5.2, "slope": 0.05, ...}
└──────────────┘


[센서 시스템]
┌──────────────┐
│sensor_final  │
│              │
│ DHT11        │──→ factory/sensor/dht11
│ 진동         │──→ factory/sensor/vibration
│ 음향         │──→ factory/sensor/sound
│ MPU6050      │──→ factory/sensor/accel_gyro
│ BMP180       │──→ factory/sensor/pressure
│              │
│ 윈도우 버퍼  │ (10초, 128 샘플)
│              │
└──────┬───────┘
       │
       │ 버퍼 충족 시
       │ WindowMessage 발행
       ▼
┌──────────────────────────────────────────────────────────────────┐
│  factory/inference/windows/accel_gyro                            │
│  {                                                               │
│    "sensor_type": "accel_gyro",                                  │
│    "sampling_rate_hz": 12.8,                                     │
│    "window_fields": {                                            │
│      "fields_accel_x": [...],                                    │
│      "fields_accel_y": [...],                                    │
│      "fields_accel_z": [...],                                    │
│      "fields_gyro_x": [...],                                     │
│      "fields_gyro_y": [...],                                     │
│      "fields_gyro_z": [...],                                     │
│      "fields_pressure_hpa": [...],                               │
│      "fields_temperature_c": [...]                               │
│    }                                                             │
│  }                                                               │
└──────────────────────────────────────────────────────────────────┘
       │
       │ MQTT 구독
       ▼
┌──────────────────────────────────────────────────────────────────┐
│  inference_worker.py                                             │
│                                                                  │
│  1. 윈도우 수신                                                   │
│  2. V17 특징 추출 (15개)                                         │
│     - PCA + 벡터 스칼라화                                        │
│     - FFT 최적화 (1회 호출로 2개 특징)                            │
│  3. 스케일링 (scaler_mlp.pkl / scaler_if.joblib)                 │
│  4. 모델 추론                                                    │
│     - Isolation Forest → iforest_score                           │
│     - MLP Classifier → mlp_s1/s2_prob_normal/yellow/red         │
│  5. 결과 발행                                                    │
└──────────────────────────────────────────────────────────────────┘
       │
       │ MQTT 발행
       ▼
┌──────────────────────────────────────────────────────────────────┐
│  factory/inference/results/accel_gyro/mlp_classifier             │
│  {                                                               │
│    "sensor_type": "accel_gyro",                                  │
│    "score": 0.05,                                                │
│    "model_name": "mlp_classifier",                               │
│    "context_payload": {                                          │
│      "fields": {                                                 │
│        "mlp_s1_prob_normal": 0.85,                               │
│        "mlp_s1_prob_yellow": 0.10,                               │
│        "mlp_s1_prob_red": 0.05,                                  │
│        "mlp_s2_prob_normal": 0.90,                               │
│        "mlp_s2_prob_yellow": 0.07,                               │
│        "mlp_s2_prob_red": 0.03                                   │
│      }                                                           │
│    }                                                             │
│  }                                                               │
└──────────────────────────────────────────────────────────────────┘
       │
       │ 결과 수신
       ▼
┌──────────────────────────────────────────────────────────────────┐
│  sensor_final.py (구독)                                          │
│  • inference_results 딕셔너리 업데이트                            │
│  • 터미널 실시간 표시: [INF] score=0.05 label=normal             │
└──────────────────────────────────────────────────────────────────┘
```

---

## 🚀 실행 방법

### 방법 1: 개별 실행 (권장)

```bash
# 터미널 1: 모터 제어
sudo python motor_PdM.py

# 터미널 2: 센서 수집
sudo python src/sensor_final.py

# 터미널 3: 추론 워커
python src/inference_worker.py
```

### 방법 2: 통합 런처

**Windows:**
```powershell
cd c:\Users\pinu4\project\python
.\run_all.bat
```

**Linux/Raspberry Pi:**
```bash
cd /home/wise/python
bash run_all.sh
```

**Python (크로스 플랫폼):**
```bash
python run_all.py
```

---

## 📁 파일 구조

```
python/
├── motor_PdM.py           # 모터 + RUL 예측 (v1)
├── motor_PdM_v2.py        # 모터 + RUL 예측 (v2, 개선)
├── src/
│   ├── sensor_final.py    # 센서 수집 + 윈도우 생성
│   ├── inference_worker.py # 추론 엔진
│   ├── inference_interface.py # 메시지 정의
│   ├── feature_extractor.py   # V17 특징 추출
│   ├── predict_mlp.py     # MLP 예측기
│   └── predict_if.py      # IF 예측기
├── models/
│   ├── mlp_classifier.onnx
│   ├── isolation_forest.joblib
│   ├── scaler_mlp.pkl
│   └── scaler_if.joblib
├── docs/
│   ├── inference.md       # 추론 시스템 문서
│   ├── motor_PdM_v2_changes.md # v2 변경 사항
│   └── 실행 구조.md       # 이 문서
└── tests/
    └── test_inference_flow.py
```

---

## ⚙️ 설정 요약

| 항목 | 값 | 파일 |
|------|-----|------|
| MQTT 브로커 | 192.168.80.143:1883 | 각 스크립트 |
| 샘플링 레이트 (IMU) | 12.8 Hz | sensor_final.py |
| 윈도우 크기 | 10.0초 | inference_interface.py |
| 윈도우 겹침 | 5.0초 | inference_interface.py |
| 특징 수 (V17) | 15개 | inference_interface.py |
| RUL 베이스라인 | 4583ms | motor_PdM_v2.py |
| RUL WARNING | +5% (4812ms) | motor_PdM_v2.py |
| RUL CRITICAL | +10% (5041ms) | motor_PdM_v2.py |
